# Telegram 汇报规则文档

## 📋 概述

系统共有 **6 条 Telegram 汇报规则**，涵盖交易操作、系统状态、因子状态和错误通知。

---

## 📨 汇报规则清单

### 1️⃣ 开仓通知 (`notify_open`)

**触发条件**：
- ✅ 开多仓成功
- ✅ 开空仓成功

**触发位置**：
- `core/logic/position_handler.py` - `handle_position()` 函数

**发送内容**：
```
🚀 Big系统状态更新
📌 ETHUSDT: 多单 0.987 张 | 开仓价: 2919.50
💰 账户余额: 4806.16 USDT
```

**包含信息**：
- 交易对
- 方向（多单/空单）
- 数量
- 开仓价
- 账户余额

---

### 2️⃣ 反手开仓通知 (`notify_reverse_open`)

**触发条件**：
- ✅ 信号反转，平仓后反手开仓成功

**触发位置**：
- `core/logic/position_handler.py` - `handle_position()` 函数（反手逻辑）

**发送内容**：
```
🔄 Big反手开仓
📌 ETHUSDT: 空单 0.987 张 | 开仓价: 2800.00
```

**包含信息**：
- 交易对
- 方向（多单/空单）
- 数量
- 开仓价

---

### 3️⃣ 平仓通知 (`notify_close`)

**触发条件**：
- ✅ 止盈15%全平
- ✅ 信号反转平仓（通过过滤器后）

**触发位置**：
- `core/logic/position_handler.py` - `handle_position()` 函数

**发送内容**：
```
📤 Big平仓
📌 ETHUSDT: 多单 0.987 张
⏳ 开仓价: 2919.50
🏁 平仓价: 3357.43
💵 盈亏: +216.00 (+15.00%)
📘 原因: 止盈15%全平
💰 当前余额: 5022.16 USDT
```

**包含信息**：
- 交易对
- 方向（多单/空单）
- 数量
- 开仓价
- 平仓价
- 盈亏（USDT 和百分比）
- 平仓原因
- 当前账户余额

**注意**：
- ⚠️ **部分止盈（10%卖出50%）不会发送 Telegram 通知**
- ✅ 只有全部平仓才会发送通知

---

### 4️⃣ 错误通知 (`notify_error`)

**触发条件**：
- ❌ 交易执行过程中发生任何错误
- ❌ 系统运行错误

**触发位置**：
- `core/runner.py` - `run_once()` 函数（捕获异常）
- `core/logic/position_handler.py` - 各种失败场景

**发送内容（普通错误）**：
```
❌ ETHUSDT 运行错误
订单创建失败: insufficient balance
```

**发送内容（名义价值错误，自动增强）**：
```
❌ ETHUSDT 运行错误
订单名义价值过小

📌 订单名义价值过小（notional < 20 USDT）
📉 当前价格: 2919.50
📦 下单数量: 0.001
💲 名义价值: 2.92 USDT
📏 Binance 最低要求: 20 USDT
🛠 建议：提高下单数量或调整仓位计算逻辑
```

**包含信息**：
- 交易对
- 错误信息
- 如果是名义价值错误，自动补充诊断信息

---

### 5️⃣ 系统状态更新 (`report_startup`)

**触发条件**：
- ✅ 每次 `run_once()` 执行完成后
- ✅ **但只有持仓状态发生变化时才发送**（去重机制）

**触发位置**：
- `core/runner.py` - `run_once()` 函数末尾

**去重机制**：
- 使用 `logs/reporter_snapshot.json` 记录上次状态
- 如果当前持仓状态与上次相同，**不发送**
- 如果持仓状态发生变化，**发送并更新快照**

**发送内容**：
```
🚀 系统状态更新
💰 账户余额: 4806.16 USDT

📌 ETHUSDT: 多单 0.987 张 | 开仓价: 2919.50
   📊 当前价: 2919.87
   💵 浮动盈亏: +0.36 (+0.01%)

📌 SOLUSDT: 无持仓
```

**包含信息**：
- 账户余额
- 每个交易对的持仓状态：
  - 有持仓：方向、数量、开仓价、当前价、浮动盈亏
  - 无持仓：显示"无持仓"

**发送频率**：
- 理论上每次 `run_once()` 都检查（每60秒）
- 实际只在持仓状态变化时发送（避免重复通知）

---

### 6️⃣ 因子状态汇报 (`hourly_factor_report`)

**触发条件**：
- ✅ 每 **10 分钟** 触发一次
- ✅ 检查条件：`当前分钟数 % 10 == 0`（例如：00分、10分、20分、30分、40分、50分）

**触发位置**：
- `core/runner.py` - `run_once()` 函数开始处

**发送内容**：
```
🕒 因子状态汇报

📊 ETHUSDT 因子状态
MA趋势: LONG
RSI: 58.5
ATR波动率: 1.2333
波动状态: HIGH

📊 SOLUSDT 因子状态
MA趋势: SHORT
RSI: 42.3
ATR波动率: 0.0340
波动状态: LOW
⚠️ SOLUSDT 波动率极低，趋势策略可能失效
```

**包含信息**：
- 每个交易对的因子状态：
  - MA趋势（LONG/SHORT）
  - RSI值
  - ATR波动率
  - 波动状态（HIGH/LOW）
- 异常提醒：
  - 波动率极低时提醒
  - 波动率异常偏高时提醒

**发送频率**：
- 每 10 分钟一次（00、10、20、30、40、50分）

---

## 📊 汇报规则汇总表

| 序号 | 规则名称 | 触发条件 | 发送频率 | 去重机制 |
|------|---------|---------|---------|---------|
| 1 | 开仓通知 | 开仓成功 | 每次开仓 | ❌ 无 |
| 2 | 反手开仓通知 | 反手开仓成功 | 每次反手 | ❌ 无 |
| 3 | 平仓通知 | 全部平仓 | 每次平仓 | ❌ 无 |
| 4 | 错误通知 | 发生错误 | 每次错误 | ❌ 无 |
| 5 | 系统状态更新 | 持仓状态变化 | 每次变化 | ✅ 有（状态对比） |
| 6 | 因子状态汇报 | 每10分钟 | 每10分钟 | ❌ 无 |

---

## 🔍 详细说明

### 去重机制详解

**系统状态更新（规则5）**：
- 使用 `logs/reporter_snapshot.json` 文件记录上次状态
- 每次检查时对比当前状态和上次状态
- 如果完全相同（持仓方向、数量、开仓价都相同），**不发送**
- 如果不同（新开仓、平仓、反手等），**发送并更新快照**

**其他规则**：
- 开仓、平仓、反手、错误通知：每次触发都发送，**不去重**
- 因子状态汇报：每10分钟固定发送，**不去重**

---

### 部分止盈不通知

**重要**：部分止盈（10%卖出50%）**不会发送 Telegram 通知**

原因：
- 部分止盈不是完整交易，只是减少仓位
- 避免通知过多，保持通知的重要性
- 只有全部平仓（15%止盈或信号反转）才会通知

如果需要部分止盈通知，可以修改 `core/logic/position_handler.py` 中的代码。

---

### 通知内容格式

所有通知使用 **HTML 格式**，支持：
- `<b>粗体</b>`
- 表情符号（emoji）
- 多行文本

---

## 🎯 通知优先级

1. **错误通知**（最高优先级）- 立即发送
2. **交易通知**（开仓/平仓/反手）- 交易成功时发送
3. **系统状态更新** - 状态变化时发送
4. **因子状态汇报** - 定时发送（每10分钟）

---

## 📝 配置说明

### Telegram 配置位置
- 文件：`config/secrets.py`
- 配置项：
  - `TELEGRAM_BOT_TOKEN` - Bot Token
  - `TELEGRAM_CHAT_ID` - 聊天ID

### 修改汇报规则

如需修改汇报规则，可编辑以下文件：
- `services/notifier.py` - 交易通知（规则1-4）
- `services/system_reporter.py` - 系统状态更新（规则5）
- `services/factor_reporter.py` - 因子状态汇报（规则6）
- `core/runner.py` - 触发逻辑

---

## ✅ 总结

系统共有 **6 条 Telegram 汇报规则**：

1. ✅ **开仓通知** - 开仓成功时
2. ✅ **反手开仓通知** - 反手成功时
3. ✅ **平仓通知** - 全部平仓时（不包括部分止盈）
4. ✅ **错误通知** - 发生错误时
5. ✅ **系统状态更新** - 持仓状态变化时（有去重）
6. ✅ **因子状态汇报** - 每10分钟定时发送

所有通知都会发送到配置的 Telegram Chat ID。

---

**最后更新**：2025-12-28

