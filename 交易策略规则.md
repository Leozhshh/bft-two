# 币安期货量化交易策略规则文档

## 📊 策略概述

**策略类型**：多时间框架趋势跟踪策略（Multi-Timeframe Trend Following）

**核心思想**：
- 使用 **4小时K线** 判断大趋势方向（主趋势）
- 使用 **1分钟K线** 执行具体交易（入场时机）
- 根据4小时趋势限制交易方向，只做同向操作
- 分级止盈：10%部分止盈，15%全部平仓

---

## 🕐 时间框架

### 主要时间框架
- **4小时K线**：判断大趋势方向（获取最近50根）
- **1分钟K线**：执行交易信号（获取最近100根）

### 执行频率
- 每 **60秒** 执行一次策略检查
- 实时监控持仓，触发止盈条件立即执行

---

## 📈 4小时趋势判断规则

### 判断方法
使用移动平均线（MA）判断：
- **快线（MA5）**：最近5根4小时K线的收盘价平均值
- **慢线（MA20）**：最近20根4小时K线的收盘价平均值

### 趋势分类
1. **上行趋势（LONG）**
   - 条件：`MA5 > MA20 × 1.001`（快线比慢线高0.1%以上）
   - 交易限制：**只允许买入（LONG）操作**

2. **下行趋势（SHORT）**
   - 条件：`MA5 < MA20 × 0.999`（快线比慢线低0.1%以上）
   - 交易限制：**只允许卖空（SHORT）操作**

3. **震荡趋势（HOLD）**
   - 条件：快慢线差距在0.1%以内
   - 交易限制：**不限制方向**，使用1分钟信号

---

## ⚡ 1分钟K线交易信号规则

### 信号生成流程

#### 第一步：风险过滤（必须全部通过）

1. **插针过滤**
   - 检查当前K线是否有异常影线
   - 条件：上影线或下影线长度 > 实体长度 × 2
   - 如果触发：返回 `HOLD`，不交易

2. **ATR波动过滤**
   - 检查当前K线波动是否异常
   - 条件：当前K线波动范围 > ATR × 2
   - 如果触发：返回 `HOLD`，不交易

#### 第二步：技术指标计算

3. **趋势因子（MA）**
   - 快线（MA5）：最近5根1分钟K线收盘价平均值
   - 慢线（MA20）：最近20根1分钟K线收盘价平均值
   - 趋势判断：
     - `MA5 > MA20` → 看涨趋势
     - `MA5 < MA20` → 看跌趋势

4. **动能因子（RSI）**
   - 周期：14
   - 判断标准：
     - `RSI > 55` → 看涨动能
     - `RSI < 45` → 看跌动能
     - `45 ≤ RSI ≤ 55` → 中性

5. **波动率因子（ATR）**
   - 周期：14
   - 阈值：最近20根K线平均价格 × 0.2%
   - 判断标准：
     - `ATR ≥ 阈值` → 波动率高（HIGH）
     - `ATR < 阈值` → 波动率低（LOW）

#### 第三步：信号融合

**买入信号（LONG）条件**（需同时满足）：
- ✅ 趋势因子：看涨（MA5 > MA20）
- ✅ 动能因子：看涨（RSI > 55）
- ✅ 波动率因子：高（ATR ≥ 阈值）
- ✅ 4小时趋势：上行或震荡（如果4小时下行，则不允许买入）

**卖空信号（SHORT）条件**（需同时满足）：
- ✅ 趋势因子：看跌（MA5 < MA20）
- ✅ 动能因子：看跌（RSI < 45）
- ✅ 波动率因子：高（ATR ≥ 阈值）
- ✅ 4小时趋势：下行或震荡（如果4小时上行，则不允许卖空）

**持仓信号（HOLD）**：
- 不满足上述任何条件

---

## 🛡️ 信号确认与过滤规则

### 1. 防抖机制（Signal Debounce）
- **规则**：首次出现的方向信号（LONG/SHORT）**不执行交易**
- **目的**：避免假信号，等待信号确认
- **执行**：需要连续两次相同信号才执行

### 2. 最小持仓时间过滤
- **规则**：持仓时间 < 5分钟时，不允许反手
- **参数**：`MIN_HOLD_SECONDS = 300秒`
- **目的**：避免频繁做T，减少交易成本

### 3. 最小价差过滤
- **规则**：价格变动 < 0.2% 时，不允许反手
- **参数**：`MIN_PRICE_CHANGE_PCT = 0.002`
- **目的**：避免小波动触发交易，减少滑点损失

---

## 💰 开仓规则

### 仓位计算
使用 **ATR风险预算** 和 **最大仓位限制** 的较小值：

1. **ATR风险预算**
   - 风险因子：1%（账户余额的1%）
   - 计算公式：`仓位 = 风险金额 / ATR`
   - 目的：根据波动率动态调整仓位

2. **最大仓位限制**
   - 杠杆：20倍
   - 最大仓位比例：3%（账户余额的3%）
   - 计算公式：`最大名义价值 = 余额 × 20 × 3%`
   - 目的：控制单笔交易风险

3. **交易所规则对齐**
   - 符合最小下单量（minQty）
   - 符合步长要求（stepSize）

### 开仓条件
- ✅ 无持仓
- ✅ 信号确认通过（防抖机制）
- ✅ 通过所有过滤器
- ✅ 4小时趋势方向允许

---

## 🎯 止盈规则

### 分级止盈策略

#### 第一级：部分止盈（10%）
- **触发条件**：获利 ≥ 10%
- **执行动作**：卖出 **50%** 持仓
- **执行次数**：仅执行一次（标记 `partial_take_profit_done = True`）
- **目的**：锁定部分利润，降低风险

#### 第二级：全部平仓（15%）
- **触发条件**：获利 ≥ 15%
- **执行动作**：**全部平仓**
- **执行后**：等待下一波段信号（反转后再反转）

### 止盈计算
- **多单（LONG）**：`盈亏% = (当前价 - 开仓价) / 开仓价 × 100%`
- **空单（SHORT）**：`盈亏% = (开仓价 - 当前价) / 开仓价 × 100%`

### 止盈优先级
1. 先检查 15% 全平条件（优先级最高）
2. 再检查 10% 部分止盈条件
3. 如果已执行部分止盈，不再重复执行

---

## 🔄 平仓与反手规则

### 平仓条件
1. **止盈触发**：达到15%全部平仓
2. **信号反转**：1分钟信号与持仓方向相反，且通过过滤器

### 反手条件
当信号反转时：
1. ✅ 先平掉当前仓位
2. ✅ 通过最小持仓时间过滤（≥5分钟）
3. ✅ 通过最小价差过滤（≥0.2%）
4. ✅ 立即反手开新仓位（同向操作）

### 反手失败处理
- 如果平仓成功但反手失败：
  - 更新为无持仓状态
  - 等待下次信号

---

## 📋 交易流程总结

### 完整交易流程

```
1. 获取4小时K线 → 判断大趋势（LONG/SHORT/HOLD）
   ↓
2. 获取1分钟K线 → 计算技术指标（MA、RSI、ATR）
   ↓
3. 风险过滤 → 插针过滤、ATR波动过滤
   ↓
4. 信号融合 → 生成1分钟交易信号
   ↓
5. 4小时趋势过滤 → 限制交易方向
   ↓
6. 信号确认 → 防抖机制（首次不交易）
   ↓
7. 过滤器检查 → 最小持仓时间、最小价差
   ↓
8. 开仓/持仓管理
   ├─ 无持仓 → 开仓
   ├─ 有持仓 → 检查止盈
   │   ├─ 获利≥15% → 全部平仓
   │   └─ 获利≥10% → 部分止盈（50%）
   └─ 信号反转 → 平仓+反手
```

---

## ⚙️ 策略参数配置

### 4小时趋势参数
- 快线周期：5
- 慢线周期：20
- 趋势阈值：0.1%

### 1分钟策略参数
- MA快线周期：5
- MA慢线周期：20
- RSI周期：14
- RSI买入阈值：55
- RSI卖出阈值：45
- ATR周期：14
- ATR波动率阈值：0.2%

### 风险控制参数
- 风险因子：1%
- 最大仓位比例：3%
- 杠杆倍数：20倍
- 最小持仓时间：5分钟
- 最小价差：0.2%

### 止盈参数
- 部分止盈阈值：10%
- 部分止盈比例：50%
- 全部平仓阈值：15%

---

## 🎯 策略特点

### 优势
1. **多时间框架**：结合4小时大趋势和1分钟入场时机
2. **方向限制**：只做趋势同向交易，降低逆势风险
3. **分级止盈**：锁定利润，降低回撤风险
4. **风险过滤**：多重过滤机制，减少假信号
5. **防抖机制**：避免频繁交易，提高信号质量

### 适用场景
- ✅ 趋势明显的市场
- ✅ 波动率适中的市场
- ✅ 4小时级别有明显趋势时效果最佳

### 注意事项
- ⚠️ 4小时震荡时，可能频繁交易
- ⚠️ 需要足够的K线数据（至少20根4小时K线）
- ⚠️ 止盈后需要等待新的波段信号

---

## 📝 日志输出说明

### 关键日志信息
- `4小时趋势: LONG/SHORT/HOLD` - 显示当前4小时趋势
- `原始信号: LONG/SHORT/HOLD` - 显示1分钟策略信号
- `信号首次出现 → 仅记录，不交易` - 防抖机制触发
- `🎯 止盈触发：获利 X% >= 15%，全部平仓` - 止盈执行
- `🎯 部分止盈触发：获利 X% >= 10%，卖出50%` - 部分止盈执行

---

**策略版本**：v3.0（多时间框架版本）  
**最后更新**：2025-12-28

