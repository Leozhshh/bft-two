# 日志系统说明文档

## 📋 日志系统概述

日志系统已改造完成，现在**所有交易操作都会同时输出到终端和写入日志文件**，方便实时查看和历史查询。

---

## 📁 日志文件结构

```
logs/
├── trade/              # 交易日志（开仓、平仓、止盈、反手）
│   └── trade_YYYY-MM-DD.log
├── signal/             # 信号日志（交易信号生成）
│   └── signal_YYYY-MM-DD.log
├── factors/            # 因子日志（技术指标状态）
│   └── factors_YYYY-MM-DD.log
├── system/              # 系统日志（系统运行状态）
│   └── system_YYYY-MM-DD.log
├── error/               # 错误日志（错误信息）
│   └── error_YYYY-MM-DD.log
└── snapshot/             # 快照日志（状态快照）
    └── snapshot_YYYY-MM-DD.log
```

---

## 🔧 日志函数说明

### 1. `log_trade()` - 交易日志（**同时输出终端和文件**）

**用途**：记录所有交易操作（开仓、平仓、止盈、反手）

**特点**：
- ✅ 自动输出到终端（带时间戳）
- ✅ 自动写入 `logs/trade/trade_YYYY-MM-DD.log`
- ✅ 使用结构化 JSON 格式存储

**示例**：
```python
log_trade(
    f"✅ {symbol} 开多仓成功 | 数量: {qty} 张 | 开仓价: {price:.2f}",
    module="position_handler"
)
```

**终端输出**：
```
[2025-12-28 10:30:45] 📊 ✅ ETHUSDT 开多仓成功 | 数量: 0.987 张 | 开仓价: 2919.50
```

**文件内容**（JSON格式）：
```json
{"timestamp": "2025-12-28 10:30:45.123", "level": "INFO", "module": "position_handler", "message": "✅ ETHUSDT 开多仓成功 | 数量: 0.987 张 | 开仓价: 2919.50"}
```

---

### 2. `log_error()` - 错误日志（**同时输出终端和文件**）

**用途**：记录所有错误信息

**特点**：
- ✅ 自动输出到终端（带时间戳）
- ✅ 自动写入 `logs/error/error_YYYY-MM-DD.log`
- ✅ 使用结构化 JSON 格式存储

**示例**：
```python
log_error(
    f"❌ {symbol} 开多仓失败: {error}",
    module="position_handler"
)
```

---

### 3. `write_log()` - 兼容旧系统日志（**同时输出终端和文件**）

**用途**：兼容旧代码，输出通用日志

**特点**：
- ✅ 自动输出到终端（带时间戳）
- ✅ 自动写入 `logs/system/system_YYYY-MM-DD.log`
- ✅ 使用结构化 JSON 格式存储

**示例**：
```python
write_log(f"[{symbol}] 当前价格: {current_price}")
```

---

### 4. 其他日志函数（**仅写入文件，可选输出终端**）

- `log_signal()` - 信号日志（默认不输出终端）
- `log_factors()` - 因子日志（默认不输出终端）
- `log_system()` - 系统日志（默认不输出终端）
- `log_snapshot()` - 快照日志（默认不输出终端）

如需输出到终端，可设置 `print_to_console=True`：
```python
log_signal("信号生成", print_to_console=True)
```

---

## 📊 交易日志记录内容

### 开仓日志
- ✅ 开多仓成功
- ✅ 开空仓成功
- ❌ 开仓失败

**记录信息**：
- 交易对
- 方向（多/空）
- 数量
- 开仓价
- 账户余额

---

### 平仓日志
- ✅ 平仓成功（信号反转）
- ✅ 止盈15%全平
- ✅ 部分止盈10%（卖出50%）
- ❌ 平仓失败

**记录信息**：
- 交易对
- 方向（多/空）
- 数量
- 开仓价
- 平仓价
- 盈亏（USDT 和百分比）
- 账户余额

---

### 反手日志
- ✅ 反手开多仓
- ✅ 反手开空仓
- ❌ 反手失败

**记录信息**：
- 交易对
- 原方向平仓信息
- 新方向开仓信息
- 盈亏情况

---

## 🔍 查询日志方法

### 1. 查看终端输出
运行程序时，所有重要日志会实时显示在终端。

### 2. 查看日志文件

**查看今天的交易日志**：
```bash
cat logs/trade/trade_$(date +%Y-%m-%d).log
```

**查看今天的错误日志**：
```bash
cat logs/error/error_$(date +%Y-%m-%d).log
```

**查看所有交易日志（按时间排序）**：
```bash
find logs/trade -name "*.log" -exec cat {} \; | sort
```

### 3. 使用 JSON 工具查询

**使用 `jq` 查询（如果已安装）**：
```bash
# 查询所有开仓记录
cat logs/trade/trade_2025-12-28.log | jq 'select(.message | contains("开仓成功"))'

# 查询所有止盈记录
cat logs/trade/trade_2025-12-28.log | jq 'select(.message | contains("止盈"))'

# 查询特定交易对
cat logs/trade/trade_2025-12-28.log | jq 'select(.message | contains("ETHUSDT"))'
```

**使用 Python 查询**：
```python
import json

# 读取日志文件
with open("logs/trade/trade_2025-12-28.log", "r") as f:
    for line in f:
        record = json.loads(line)
        if "开仓成功" in record["message"]:
            print(record)
```

---

## 📝 日志格式说明

### 终端输出格式
```
[YYYY-MM-DD HH:MM:SS] 📊 日志内容
[YYYY-MM-DD HH:MM:SS] ❌ 错误内容
[YYYY-MM-DD HH:MM:SS] 📡 信号内容
```

### 文件存储格式（JSON）
```json
{
  "timestamp": "2025-12-28 10:30:45.123",
  "level": "INFO",
  "module": "position_handler",
  "message": "日志内容",
  "extra": {
    "optional": "额外信息"
  }
}
```

---

## 🎯 关键交易操作日志示例

### 开多仓
```
[2025-12-28 10:30:45] 📊 ✅ ETHUSDT 开多仓成功 | 数量: 0.987 张 | 开仓价: 2919.50 | 账户余额: 4806.16 USDT
```

### 部分止盈
```
[2025-12-28 11:15:30] 📊 🎯 ETHUSDT 部分止盈10% | 方向: LONG | 卖出: 0.493 张 | 剩余: 0.494 张 | 开仓价: 2919.50 | 平仓价: 3211.45 | 盈亏: +144.00 (+10.00%)
```

### 全部平仓
```
[2025-12-28 11:30:15] 📊 🎯 ETHUSDT 止盈15%全平 | 方向: LONG | 数量: 0.494 张 | 开仓价: 2919.50 | 平仓价: 3357.43 | 盈亏: +216.00 (+15.00%) | 账户余额: 5022.16 USDT | 等待下一波段信号
```

### 反手操作
```
[2025-12-28 12:00:00] 📊 🔄 ETHUSDT 平多仓（信号反转） | 数量: 0.987 张 | 开仓价: 2919.50 | 平仓价: 2800.00 | 盈亏: -117.80 (-4.03%)
[2025-12-28 12:00:01] 📊 🔄 ETHUSDT 反手开空仓 | 数量: 0.987 张 | 开仓价: 2800.00 | 账户余额: 4688.36 USDT
```

---

## ✅ 日志系统改进总结

### 改进前
- ❌ `log_trade()` 只写入文件，不输出终端
- ❌ 交易操作缺少详细日志
- ❌ 难以实时查看交易状态

### 改进后
- ✅ `log_trade()` 同时输出终端和文件
- ✅ `log_error()` 同时输出终端和文件
- ✅ 所有交易操作都有详细日志记录
- ✅ 终端实时显示，文件永久保存
- ✅ 结构化 JSON 格式，方便查询和分析

---

## 🔧 配置说明

日志文件自动按日期分割，每天生成一个新文件。

日志目录会自动创建，无需手动创建。

所有日志使用 UTF-8 编码，支持中文。

---

**最后更新**：2025-12-28

